import React, { useState } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { ChevronLeft, ChevronRight, Check } from "lucide-react";
import * as options from "./formOptions";

interface LeadFormData {
  // Section 1
  identity: {
    fullName: string;
    email: string;
    phone: string;
    residencyStatus: string;
    residencyDetails: string;
    discoverySource: string;
    discoveryDetails: string;
  };
  // Section 2
  demographics: {
    ageGroup: string;
    professions: string[];
    householdSize: string;
    annualIncomeRange: string;
    notes: string;
  };
  // Section 3
  propertyVision: {
    propertiesPurchasedBefore: string;
    propertyPurpose: string[];
    propertyPurposeDetails: string;
    buyingMotivation: string[];
    buyingMotivationDetails: string;
    shortTermRentalPreference: string;
    assetTypes: string[];
    assetTypesDetails: string;
    waterSourcePreference: string;
    unitConfigurations: string[];
    unitConfigurationsDetails: string;
    farmlandSize: string;
    farmlandSizeDetails: string;
    farmlandSizeAcres: number | undefined;
    farmlandVillaConfig: string;
    journeyStage: string;
    journeyStageDetails: string;
    explorationDuration: string;
    explorationDurationDetails: string;
    purchaseTimeline: string;
    purchaseTimelineDetails: string;
    budgetRange: string;
    budgetRangeDetails: string;
    notes: string;
  };
  // Section 4
  investmentPreferences: {
    ownershipStructure: string;
    ownershipStructureDetails: string;
    possessionTimeline: string;
    possessionTimelineDetails: string;
    managementModel: string;
    managementModelDetails: string;
    fundingType: string;
    fundingTypeDetails: string;
    notes: string;
  };
  // Section 5
  locationPreferences: {
    currentCity: string;
    currentState: string;
    currentCountry: string;
    buyingRegions: string[];
    preferredCountries: string[];
    preferredStates: string[];
    preferredCities: string[];
    preferredCitiesDetails: string;
    climateRisksToAvoid: string[];
    climatePreference: string[];
    climatePreferenceDetails: string;
    locationPriorities: string[];
    locationPrioritiesDetails: string;
    expansionRadiusKm: string;
    expansionRadiusDetails: string;
    notes: string;
  };
  // Section 6
  lifestylePreferences: {
    areaType: string[];
    areaTypeDetails: string;
    energyPreference: string[];
    energyPreferenceDetails: string;
    natureFeature: string[];
    natureFeatureDetails: string;
    terrainPreference: string[];
    terrainPreferenceDetails: string;
    viewPreferences: string[];
    viewPreferencesDetails: string;
    communityFormat: string;
    communityFormatDetails: string;
    gatedPreference: string;
    communityFriendlyFor: string[];
    communityFriendlyForDetails: string;
    outdoorAmenities: string[];
    notes: string;
  };
  // Section 7
  unitPreferences: {
    vastuDirections: string[];
    furnishingLevel: string;
    furnishingLevelDetails: string;
    interiorStyle: string;
    interiorStyleDetails: string;
    smartHomeFeatures: string[];
    smartHomeFeaturesDetails: string;
    mustHaveFeatures: string[];
    mustHaveFeaturesDetails: string;
    notes: string;
  };
  // Section 8
  dreamHomeNotes: string;
}

const initialFormData: LeadFormData = {
  identity: {
    fullName: "",
    email: "",
    phone: "",
    residencyStatus: "",
    residencyDetails: "",
    discoverySource: "",
    discoveryDetails: "",
  },
  demographics: {
    ageGroup: "",
    professions: [],
    householdSize: "",
    annualIncomeRange: "",
    notes: "",
  },
  propertyVision: {
    propertiesPurchasedBefore: "",
    propertyPurpose: [],
    propertyPurposeDetails: "",
    buyingMotivation: [],
    buyingMotivationDetails: "",
    shortTermRentalPreference: "",
    assetTypes: [],
    assetTypesDetails: "",
    waterSourcePreference: "",
    unitConfigurations: [],
    unitConfigurationsDetails: "",
    farmlandSize: "",
    farmlandSizeDetails: "",
    farmlandSizeAcres: undefined,
    farmlandVillaConfig: "",
    journeyStage: "",
    journeyStageDetails: "",
    explorationDuration: "",
    explorationDurationDetails: "",
    purchaseTimeline: "",
    purchaseTimelineDetails: "",
    budgetRange: "",
    budgetRangeDetails: "",
    notes: "",
  },
  investmentPreferences: {
    ownershipStructure: "",
    ownershipStructureDetails: "",
    possessionTimeline: "",
    possessionTimelineDetails: "",
    managementModel: "",
    managementModelDetails: "",
    fundingType: "",
    fundingTypeDetails: "",
    notes: "",
  },
  locationPreferences: {
    currentCity: "",
    currentState: "",
    currentCountry: "India",
    buyingRegions: [],
    preferredCountries: [],
    preferredStates: [],
    preferredCities: [],
    preferredCitiesDetails: "",
    climateRisksToAvoid: [],
    climatePreference: [],
    climatePreferenceDetails: "",
    locationPriorities: [],
    locationPrioritiesDetails: "",
    expansionRadiusKm: "",
    expansionRadiusDetails: "",
    notes: "",
  },
  lifestylePreferences: {
    areaType: [],
    areaTypeDetails: "",
    energyPreference: [],
    energyPreferenceDetails: "",
    natureFeature: [],
    natureFeatureDetails: "",
    terrainPreference: [],
    terrainPreferenceDetails: "",
    viewPreferences: [],
    viewPreferencesDetails: "",
    communityFormat: "",
    communityFormatDetails: "",
    gatedPreference: "",
    communityFriendlyFor: [],
    communityFriendlyForDetails: "",
    outdoorAmenities: [],
    notes: "",
  },
  unitPreferences: {
    vastuDirections: [],
    furnishingLevel: "",
    furnishingLevelDetails: "",
    interiorStyle: "",
    interiorStyleDetails: "",
    smartHomeFeatures: [],
    smartHomeFeaturesDetails: "",
    mustHaveFeatures: [],
    mustHaveFeaturesDetails: "",
    notes: "",
  },
  dreamHomeNotes: "",
};

interface Props {
  onSubmit: (data: LeadFormData) => Promise<void>;
  onCancel: () => void;
  loading: boolean;
  mode?: 'modal' | 'page';
  initialData?: any;
}

const STEPS = [
  { id: 1, title: "Welcome", subtitle: "Let's Begin Your Property Journey" },
  { id: 2, title: "About You", subtitle: "Let's Get to Know You" },
  { id: 3, title: "Property Vision", subtitle: "Your Property Goals" },
  { id: 4, title: "Investment", subtitle: "Investment Preferences" },
  { id: 5, title: "Location", subtitle: "Where Life Happens" },
  { id: 6, title: "Lifestyle", subtitle: "Vibe & Community" },
  { id: 7, title: "Home Details", subtitle: "Inside Your Ideal Home" },
  { id: 8, title: "Final Notes", subtitle: "Dream Home Details" },
];

export default function LeadFormWizard({ onSubmit, onCancel, loading, mode = 'modal', initialData }: Props) {
  const [formData, setFormData] = useState<LeadFormData>(initialFormData);
  const [errors, setErrors] = useState<Record<string, string>>({});


  const renderFormContent = () => {
    return (
      <div>
        <div>Form Header</div>
        <div>Form Content</div>
        <div>Form Footer</div>
      </div>
    );
  };

  const updateField = (section: keyof LeadFormData, field: string, value: unknown) => {
    setFormData((prev) => ({
      ...prev,
      [section]: {
        ...(prev[section] as Record<string, unknown>),
        [field]: value,
      },
    }));
    setErrors((prev) => ({ ...prev, [`${section}.${field}`]: "" }));
  };

  const toggleArrayField = (section: keyof LeadFormData, field: string, value: string) => {
    const currentArray = (formData[section] as Record<string, unknown>)[field] as string[];
    const newArray = currentArray.includes(value)
      ? currentArray.filter((v) => v !== value)
      : [...currentArray, value];
    updateField(section, field, newArray);
  };

  const validateStep = (): boolean => {
    const newErrors: Record<string, string> = {};

    if (step === 1) {
      if (!formData.identity.fullName.trim()) newErrors["identity.fullName"] = "Name is required";
      if (!formData.identity.email.trim()) newErrors["identity.email"] = "Email is required";
      if (!formData.identity.phone.trim()) newErrors["identity.phone"] = "Phone is required";
    }

    if (step === 3) {
      if (!formData.propertyVision.budgetRange) newErrors["propertyVision.budgetRange"] = "Budget is required";
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleNext = () => {
    if (validateStep()) {
      setStep((s) => Math.min(s + 1, STEPS.length));
    }
  };

  const handleBack = () => setStep((s) => Math.max(s - 1, 1));

  const handleSubmit = async () => {
    if (validateStep()) {
      await onSubmit(formData);
    }
  };

  const SelectField = ({
    label,
    helper,
    value,
    options: opts,
    onChange,
    required,
    showOther,
    otherValue,
    onOtherChange,
    error,
  }: {
    label: string;
    helper?: string;
    value: string;
    options: string[];
    onChange: (v: string) => void;
    required?: boolean;
    showOther?: boolean;
    otherValue?: string;
    onOtherChange?: (v: string) => void;
    error?: string;
  }) => (
    <div className="mb-4">
      <label className="block text-sm font-medium text-gray-300 mb-1">
        {label} {required && <span className="text-red-400">*</span>}
      </label>
      {helper && <p className="text-xs text-gray-500 mb-2">{helper}</p>}
      <select
        value={value}
        onChange={(e) => onChange(e.target.value)}
        className="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white"
      >
        <option value="">Select...</option>
        {opts.map((opt) => (
          <option key={opt} value={opt}>{opt}</option>
        ))}
      </select>
      {showOther && value === "Other" && (
        <Input
          placeholder="Please specify..."
          value={otherValue || ""}
          onChange={(e) => onOtherChange?.(e.target.value)}
          className="mt-2 bg-gray-800 border-gray-700"
        />
      )}
      {error && <p className="text-xs text-red-400 mt-1">{error}</p>}
    </div>
  );

  const MultiSelectField = ({
    label,
    helper,
    values,
    options: opts,
    onToggle,
    showOther,
    otherValue,
    onOtherChange,
    maxSelect,
  }: {
    label: string;
    helper?: string;
    values: string[];
    options: string[];
    onToggle: (v: string) => void;
    showOther?: boolean;
    otherValue?: string;
    onOtherChange?: (v: string) => void;
    maxSelect?: number;
  }) => (
    <div className="mb-4">
      <label className="block text-sm font-medium text-gray-300 mb-1">{label}</label>
      {helper && <p className="text-xs text-gray-500 mb-2">{helper}</p>}
      {maxSelect && <p className="text-xs text-blue-400 mb-2">Select up to {maxSelect}</p>}
      <div className="flex flex-wrap gap-2 max-h-48 overflow-y-auto p-2 bg-gray-800/50 rounded border border-gray-700">
        {opts.map((opt) => (
          <button
            key={opt}
            type="button"
            onClick={() => {
              if (maxSelect && !values.includes(opt) && values.length >= maxSelect) return;
              onToggle(opt);
            }}
            className={`px-3 py-1 rounded-full text-xs transition ${
              values.includes(opt)
                ? "bg-blue-600 text-white"
                : "bg-gray-700 text-gray-300 hover:bg-gray-600"
            }`}
          >
            {opt}
          </button>
        ))}
      </div>
      {showOther && values.includes("Other") && (
        <Input
          placeholder="Please specify..."
          value={otherValue || ""}
          onChange={(e) => onOtherChange?.(e.target.value)}
          className="mt-2 bg-gray-800 border-gray-700"
        />
      )}
    </div>
  );

  const TextAreaField = ({ label, helper, value, onChange, placeholder }: {
    label: string;
    helper?: string;
    value: string;
    onChange: (v: string) => void;
    placeholder?: string;
  }) => (
    <div className="mb-4">
      <label className="block text-sm font-medium text-gray-300 mb-1">{label}</label>
      {helper && <p className="text-xs text-gray-500 mb-2">{helper}</p>}
      <textarea
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        className="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white min-h-[100px] resize-none"
      />
    </div>
  );

  const showFarmlandOptions = formData.propertyVision.assetTypes.some(
    (t) => t.toLowerCase().includes("farmland")
  );

  if (mode === 'page') {
    return (
      <div className="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-3xl mx-auto flex flex-col">
        {renderFormContent()}
      </div>
    );
  }

  // Modal mode
  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-3xl max-h-[90vh] flex flex-col">
        {renderFormContent()}
      </div>
    </div>
  );
}
        {/* Header */}
        <div className="p-6 border-b border-gray-700">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h2 className="text-xl font-semibold text-white">Avacasa Property Match Intelligence Form</h2>
              <p className="text-sm text-gray-400">Your Journey to the Perfect Property Starts Here</p>
            </div>
            <button onClick={onCancel} className="text-gray-400 hover:text-white text-2xl">&times;</button>
          </div>
          
          {/* Progress */}
          <div className="flex items-center gap-1">
            {STEPS.map((s, i) => (
              <div key={s.id} className="flex-1">
                <div
                  className={`h-2 rounded-full ${
                    i + 1 < step ? "bg-green-500" : i + 1 === step ? "bg-blue-500" : "bg-gray-700"
                  }`}
                />
              </div>
            ))}
          </div>
          <div className="mt-2 text-center">
            <span className="text-sm text-gray-400">
              Step {step} of {STEPS.length}: {STEPS[step - 1].title}
            </span>
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6">
          {/* Step 1: Welcome */}
          {step === 1 && (
            <div>
              <h3 className="text-lg font-semibold mb-2">Welcome to Avacasa</h3>
              <p className="text-sm text-gray-400 mb-6">Before we curate your shortlist, we'd love to know a few basics.</p>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-300 mb-1">
                  What should we call you? <span className="text-red-400">*</span>
                </label>
                <p className="text-xs text-gray-500 mb-2">Your full name helps us personalize your experience.</p>
                <Input
                  value={formData.identity.fullName}
                  onChange={(e) => updateField("identity", "fullName", e.target.value)}
                  className="bg-gray-800 border-gray-700"
                  placeholder="Full Name"
                />
                {errors["identity.fullName"] && <p className="text-xs text-red-400 mt-1">{errors["identity.fullName"]}</p>}
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-300 mb-1">
                  Your best email address <span className="text-red-400">*</span>
                </label>
                <p className="text-xs text-gray-500 mb-2">We'll send your curated matches and important updates here.</p>
                <Input
                  type="email"
                  value={formData.identity.email}
                  onChange={(e) => updateField("identity", "email", e.target.value)}
                  className="bg-gray-800 border-gray-700"
                  placeholder="Email"
                />
                {errors["identity.email"] && <p className="text-xs text-red-400 mt-1">{errors["identity.email"]}</p>}
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-300 mb-1">
                  Mobile number (WhatsApp preferred) <span className="text-red-400">*</span>
                </label>
                <p className="text-xs text-gray-500 mb-2">For quick property alerts and personal consultations.</p>
                <Input
                  value={formData.identity.phone}
                  onChange={(e) => updateField("identity", "phone", e.target.value)}
                  className="bg-gray-800 border-gray-700"
                  placeholder="Phone Number"
                />
                {errors["identity.phone"] && <p className="text-xs text-red-400 mt-1">{errors["identity.phone"]}</p>}
              </div>

              <SelectField
                label="How would you describe your residency / nationality?"
                helper="Please state your residential status."
                value={formData.identity.residencyStatus}
                options={options.residencyOptions}
                onChange={(v) => updateField("identity", "residencyStatus", v)}
                showOther
                otherValue={formData.identity.residencyDetails}
                onOtherChange={(v) => updateField("identity", "residencyDetails", v)}
              />

              <SelectField
                label="How did you discover Avacasa?"
                value={formData.identity.discoverySource}
                options={options.discoverySourceOptions}
                onChange={(v) => updateField("identity", "discoverySource", v)}
                showOther
                otherValue={formData.identity.discoveryDetails}
                onOtherChange={(v) => updateField("identity", "discoveryDetails", v)}
              />
            </div>
          )}

          {/* Step 2: Demographics */}
          {step === 2 && (
            <div>
              <h3 className="text-lg font-semibold mb-2">Let's Get to Know You</h3>
              <p className="text-sm text-gray-400 mb-6">This helps us personalize every recommendation.</p>

              <SelectField
                label="Which age group do you belong to?"
                helper="Different life stages inspire different property dreams."
                value={formData.demographics.ageGroup}
                options={options.ageGroupOptions}
                onChange={(v) => updateField("demographics", "ageGroup", v)}
              />

              <MultiSelectField
                label="What describes your current profession?"
                helper="Your work style shapes your lifestyle needs."
                values={formData.demographics.professions}
                options={options.professionOptions}
                onToggle={(v) => toggleArrayField("demographics", "professions", v)}
              />

              <SelectField
                label="How many people are in your household (including you)?"
                helper="Family size influences space needs and configuration."
                value={formData.demographics.householdSize}
                options={options.householdSizeOptions}
                onChange={(v) => updateField("demographics", "householdSize", v)}
              />

              <SelectField
                label="Your household income range (annual)"
                helper="This helps us suggest realistic options."
                value={formData.demographics.annualIncomeRange}
                options={options.incomeRangeOptions}
                onChange={(v) => updateField("demographics", "annualIncomeRange", v)}
              />

              <TextAreaField
                label="Anything else about your buying journey? (optional)"
                value={formData.demographics.notes}
                onChange={(v) => updateField("demographics", "notes", v)}
              />
            </div>
          )}

          {/* Step 3: Property Vision */}
          {step === 3 && (
            <div>
              <h3 className="text-lg font-semibold mb-2">Your Property Vision</h3>
              <p className="text-sm text-gray-400 mb-6">Let's get specific about your goals and budget.</p>

              <SelectField
                label="How many properties have you purchased before?"
                helper="Whether you're a first-time buyer or seasoned investor, we'll tailor our guidance."
                value={formData.propertyVision.propertiesPurchasedBefore}
                options={options.propertiesPurchasedOptions}
                onChange={(v) => updateField("propertyVision", "propertiesPurchasedBefore", v)}
              />

              <MultiSelectField
                label="What role should this property primarily play for you?"
                helper="This is the main lens we'll use to shortlist the right asset type."
                values={formData.propertyVision.propertyPurpose}
                options={options.propertyPurposeOptions}
                onToggle={(v) => toggleArrayField("propertyVision", "propertyPurpose", v)}
                showOther
                otherValue={formData.propertyVision.propertyPurposeDetails}
                onOtherChange={(v) => updateField("propertyVision", "propertyPurposeDetails", v)}
              />

              <MultiSelectField
                label="What's prompting your property search right now?"
                helper="This tells us the moment you're in."
                values={formData.propertyVision.buyingMotivation}
                options={options.buyingMotivationOptions}
                onToggle={(v) => toggleArrayField("propertyVision", "buyingMotivation", v)}
                showOther
                otherValue={formData.propertyVision.buyingMotivationDetails}
                onOtherChange={(v) => updateField("propertyVision", "buyingMotivationDetails", v)}
              />

              <SelectField
                label="How important is it that short-term rentals are allowed?"
                helper="STR viability depends on zoning/permits and society rules."
                value={formData.propertyVision.shortTermRentalPreference}
                options={options.shortTermRentalOptions}
                onChange={(v) => updateField("propertyVision", "shortTermRentalPreference", v)}
              />

              <MultiSelectField
                label="What asset are you interested in?"
                helper="What kind of property are you envisioning?"
                values={formData.propertyVision.assetTypes}
                options={options.assetTypeOptions}
                onToggle={(v) => toggleArrayField("propertyVision", "assetTypes", v)}
                showOther
                otherValue={formData.propertyVision.assetTypesDetails}
                onOtherChange={(v) => updateField("propertyVision", "assetTypesDetails", v)}
              />

              {showFarmlandOptions && (
                <>
                  <SelectField
                    label="What water source would you prefer? (For Farmland)"
                    helper="Water reliability is key for long-term land quality."
                    value={formData.propertyVision.waterSourcePreference}
                    options={options.waterSourceOptions}
                    onChange={(v) => updateField("propertyVision", "waterSourcePreference", v)}
                  />

                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-300 mb-1">Preferred farmland size</label>
                    <div className="flex gap-2">
                      <select
                        value={formData.propertyVision.farmlandSize}
                        onChange={(e) => updateField("propertyVision", "farmlandSize", e.target.value)}
                        className="flex-1 px-3 py-2 rounded bg-gray-800 border border-gray-700 text-white"
                      >
                        <option value="">Select size range...</option>
                        {options.farmlandSizeOptions.map((opt) => (
                          <option key={opt} value={opt}>{opt}</option>
                        ))}
                      </select>
                      <Input
                        type="number"
                        placeholder="Acres"
                        value={formData.propertyVision.farmlandSizeAcres || ""}
                        onChange={(e) => updateField("propertyVision", "farmlandSizeAcres", e.target.value ? Number(e.target.value) : undefined)}
                        className="w-24 bg-gray-800 border-gray-700"
                      />
                    </div>
                  </div>

                  <SelectField
                    label="If Farmland with Villa, what size?"
                    value={formData.propertyVision.farmlandVillaConfig}
                    options={options.unitConfigurationOptions}
                    onChange={(v) => updateField("propertyVision", "farmlandVillaConfig", v)}
                  />
                </>
              )}

              <MultiSelectField
                label="Preferred unit configuration"
                helper="What size and layout work best for your needs?"
                values={formData.propertyVision.unitConfigurations}
                options={options.unitConfigurationOptions}
                onToggle={(v) => toggleArrayField("propertyVision", "unitConfigurations", v)}
              />

              <SelectField
                label="Where are you on your buying journey?"
                helper="Understanding your stage helps us guide you with the right pace."
                value={formData.propertyVision.journeyStage}
                options={options.journeyStageOptions}
                onChange={(v) => updateField("propertyVision", "journeyStage", v)}
              />

              <SelectField
                label="How long have you been exploring this purchase?"
                value={formData.propertyVision.explorationDuration}
                options={options.explorationDurationOptions}
                onChange={(v) => updateField("propertyVision", "explorationDuration", v)}
              />

              <SelectField
                label="How soon are you looking to complete this purchase?"
                value={formData.propertyVision.purchaseTimeline}
                options={options.purchaseTimelineOptions}
                onChange={(v) => updateField("propertyVision", "purchaseTimeline", v)}
                required
              />

              <SelectField
                label="What's your total budget range for this purchase?"
                helper="Your budget range ensures we only show you properties within financial reach."
                value={formData.propertyVision.budgetRange}
                options={options.budgetRangeOptions}
                onChange={(v) => updateField("propertyVision", "budgetRange", v)}
                required
                error={errors["propertyVision.budgetRange"]}
              />

              <TextAreaField
                label="If you want to tell us more, add details here (optional)"
                value={formData.propertyVision.notes}
                onChange={(v) => updateField("propertyVision", "notes", v)}
              />
            </div>
          )}

          {/* Step 4: Investment */}
          {step === 4 && (
            <div>
              <h3 className="text-lg font-semibold mb-2">Investment Snapshot</h3>
              <p className="text-sm text-gray-400 mb-6">Help us understand your investment preferences.</p>

              <SelectField
                label="Preferred ownership structure"
                helper="How do you want to own this asset?"
                value={formData.investmentPreferences.ownershipStructure}
                options={options.ownershipStructureOptions}
                onChange={(v) => updateField("investmentPreferences", "ownershipStructure", v)}
              />

              <SelectField
                label="Preferred possession timeline"
                helper="When do you want to take possession?"
                value={formData.investmentPreferences.possessionTimeline}
                options={options.possessionTimelineOptions}
                onChange={(v) => updateField("investmentPreferences", "possessionTimeline", v)}
              />

              <SelectField
                label="Preferred management model"
                helper="Do you want professional management or hands-on control?"
                value={formData.investmentPreferences.managementModel}
                options={options.managementModelOptions}
                onChange={(v) => updateField("investmentPreferences", "managementModel", v)}
              />

              <SelectField
                label="Funding preference"
                helper="This helps us recommend properties with favorable financing."
                value={formData.investmentPreferences.fundingType}
                options={options.fundingTypeOptions}
                onChange={(v) => updateField("investmentPreferences", "fundingType", v)}
              />

              <TextAreaField
                label="If you want to tell us more, add details here (optional)"
                value={formData.investmentPreferences.notes}
                onChange={(v) => updateField("investmentPreferences", "notes", v)}
              />
            </div>
          )}

          {/* Step 5: Location */}
          {step === 5 && (
            <div>
              <h3 className="text-lg font-semibold mb-2">Location - Where Life Happens</h3>
              <p className="text-sm text-gray-400 mb-6">Help us find the perfect location for you.</p>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-300 mb-1">Where do you currently call home?</label>
                <p className="text-xs text-gray-500 mb-2">City, State, Country</p>
                <div className="grid grid-cols-3 gap-2">
                  <Input
                    placeholder="City"
                    value={formData.locationPreferences.currentCity}
                    onChange={(e) => updateField("locationPreferences", "currentCity", e.target.value)}
                    className="bg-gray-800 border-gray-700"
                  />
                  <Input
                    placeholder="State"
                    value={formData.locationPreferences.currentState}
                    onChange={(e) => updateField("locationPreferences", "currentState", e.target.value)}
                    className="bg-gray-800 border-gray-700"
                  />
                  <Input
                    placeholder="Country"
                    value={formData.locationPreferences.currentCountry}
                    onChange={(e) => updateField("locationPreferences", "currentCountry", e.target.value)}
                    className="bg-gray-800 border-gray-700"
                  />
                </div>
              </div>

              <MultiSelectField
                label="Where are you interested in buying property?"
                values={formData.locationPreferences.buyingRegions}
                options={options.buyingRegionOptions}
                onToggle={(v) => toggleArrayField("locationPreferences", "buyingRegions", v)}
              />

              <MultiSelectField
                label="Which countries?"
                values={formData.locationPreferences.preferredCountries}
                options={options.countryOptions}
                onToggle={(v) => toggleArrayField("locationPreferences", "preferredCountries", v)}
              />

              <MultiSelectField
                label="Which states are you interested in?"
                values={formData.locationPreferences.preferredStates}
                options={formData.locationPreferences.preferredCountries.flatMap((c) => options.stateOptions[c] || [])}
                onToggle={(v) => toggleArrayField("locationPreferences", "preferredStates", v)}
              />

              <MultiSelectField
                label="Which cities/locations?"
                values={formData.locationPreferences.preferredCities}
                options={formData.locationPreferences.preferredStates.flatMap((s) => options.cityOptions[s] || [])}
                onToggle={(v) => toggleArrayField("locationPreferences", "preferredCities", v)}
                showOther
                otherValue={formData.locationPreferences.preferredCitiesDetails}
                onOtherChange={(v) => updateField("locationPreferences", "preferredCitiesDetails", v)}
              />

              <MultiSelectField
                label="Which climate or environmental risks do you want to avoid?"
                helper="This helps us avoid locations with higher risk."
                values={formData.locationPreferences.climateRisksToAvoid}
                options={options.climateRiskOptions}
                onToggle={(v) => toggleArrayField("locationPreferences", "climateRisksToAvoid", v)}
              />

              <MultiSelectField
                label="What climate do you personally enjoy most?"
                values={formData.locationPreferences.climatePreference}
                options={options.climatePreferenceOptions}
                onToggle={(v) => toggleArrayField("locationPreferences", "climatePreference", v)}
              />

              <MultiSelectField
                label="What matters most for you in your dream location? (Select top 3)"
                values={formData.locationPreferences.locationPriorities}
                options={options.locationPriorityOptions}
                onToggle={(v) => toggleArrayField("locationPreferences", "locationPriorities", v)}
                maxSelect={3}
              />

              <SelectField
                label="Are you comfortable expanding your location radius?"
                helper="Allows us to recommend properties near your specified location."
                value={formData.locationPreferences.expansionRadiusKm}
                options={options.expansionRadiusOptions}
                onChange={(v) => updateField("locationPreferences", "expansionRadiusKm", v)}
              />

              <TextAreaField
                label="Any other location preferences or deal-breakers? (optional)"
                value={formData.locationPreferences.notes}
                onChange={(v) => updateField("locationPreferences", "notes", v)}
              />
            </div>
          )}

          {/* Step 6: Lifestyle */}
          {step === 6 && (
            <div>
              <h3 className="text-lg font-semibold mb-2">Vibe, Community & Lifestyle</h3>
              <p className="text-sm text-gray-400 mb-6">Let's find the environment that feels like home.</p>

              <MultiSelectField
                label="What type of area do you prefer?"
                values={formData.lifestylePreferences.areaType}
                options={options.areaTypeOptions}
                onToggle={(v) => toggleArrayField("lifestylePreferences", "areaType", v)}
              />

              <MultiSelectField
                label="What overall energy do you want around the home?"
                values={formData.lifestylePreferences.energyPreference}
                options={options.energyPreferenceOptions}
                onToggle={(v) => toggleArrayField("lifestylePreferences", "energyPreference", v)}
              />

              <MultiSelectField
                label="Which natural feature do you want closest?"
                values={formData.lifestylePreferences.natureFeature}
                options={options.natureFeatureOptions}
                onToggle={(v) => toggleArrayField("lifestylePreferences", "natureFeature", v)}
              />

              <MultiSelectField
                label="What terrain/topography do you prefer?"
                values={formData.lifestylePreferences.terrainPreference}
                options={options.terrainOptions}
                onToggle={(v) => toggleArrayField("lifestylePreferences", "terrainPreference", v)}
              />

              <MultiSelectField
                label="Preferred views"
                values={formData.lifestylePreferences.viewPreferences}
                options={options.viewPreferenceOptions}
                onToggle={(v) => toggleArrayField("lifestylePreferences", "viewPreferences", v)}
              />

              <SelectField
                label="What home/community format do you prefer?"
                value={formData.lifestylePreferences.communityFormat}
                options={options.communityFormatOptions}
                onChange={(v) => updateField("lifestylePreferences", "communityFormat", v)}
              />

              <SelectField
                label="Do you prefer a gated/security-controlled setup?"
                value={formData.lifestylePreferences.gatedPreference}
                options={options.gatedPreferenceOptions}
                onChange={(v) => updateField("lifestylePreferences", "gatedPreference", v)}
              />

              <MultiSelectField
                label="What should the community be friendly for?"
                values={formData.lifestylePreferences.communityFriendlyFor}
                options={options.communityFriendlyOptions}
                onToggle={(v) => toggleArrayField("lifestylePreferences", "communityFriendlyFor", v)}
              />

              <MultiSelectField
                label="Outdoor amenities you'd like within the community (Choose Top 5)"
                values={formData.lifestylePreferences.outdoorAmenities}
                options={options.outdoorAmenitiesOptions}
                onToggle={(v) => toggleArrayField("lifestylePreferences", "outdoorAmenities", v)}
                maxSelect={5}
              />

              <TextAreaField
                label="Any other lifestyle preferences? (optional)"
                value={formData.lifestylePreferences.notes}
                onChange={(v) => updateField("lifestylePreferences", "notes", v)}
              />
            </div>
          )}

          {/* Step 7: Unit Preferences */}
          {step === 7 && (
            <div>
              <h3 className="text-lg font-semibold mb-2">Inside Your Ideal Home</h3>
              <p className="text-sm text-gray-400 mb-6">Unit details that matter to you.</p>

              <MultiSelectField
                label="House Facing Direction (Vastu)"
                helper="If Vastu matters to you, select your preferred directions."
                values={formData.unitPreferences.vastuDirections}
                options={options.vastuDirectionOptions}
                onToggle={(v) => toggleArrayField("unitPreferences", "vastuDirections", v)}
              />

              <SelectField
                label="Preferred furnishing level"
                helper="How ready do you want the home to be when you move in?"
                value={formData.unitPreferences.furnishingLevel}
                options={options.furnishingLevelOptions}
                onChange={(v) => updateField("unitPreferences", "furnishingLevel", v)}
              />

              <SelectField
                label="Interior style you prefer"
                helper="What aesthetic resonates with you?"
                value={formData.unitPreferences.interiorStyle}
                options={options.interiorStyleOptions}
                onChange={(v) => updateField("unitPreferences", "interiorStyle", v)}
              />

              <MultiSelectField
                label="Smart home preferences"
                helper="Technology that simplifies life."
                values={formData.unitPreferences.smartHomeFeatures}
                options={options.smartHomeFeatureOptions}
                onToggle={(v) => toggleArrayField("unitPreferences", "smartHomeFeatures", v)}
              />

              <MultiSelectField
                label="Must-have features inside the home (Choose top 5)"
                helper="These are the details that make a house feel like home."
                values={formData.unitPreferences.mustHaveFeatures}
                options={options.mustHaveFeatureOptions}
                onToggle={(v) => toggleArrayField("unitPreferences", "mustHaveFeatures", v)}
                maxSelect={5}
              />

              <TextAreaField
                label="Any other unit preferences? (optional)"
                value={formData.unitPreferences.notes}
                onChange={(v) => updateField("unitPreferences", "notes", v)}
              />
            </div>
          )}

          {/* Step 8: Final Notes */}
          {step === 8 && (
            <div>
              <h3 className="text-lg font-semibold mb-2">Tell Us About Your Dream Home</h3>
              <p className="text-sm text-gray-400 mb-6">
                Unique requirements? Accessibility needs? Design preferences? The smallest detail could be the deciding factor.
              </p>

              <TextAreaField
                label="Anything else about your ideal home?"
                value={formData.dreamHomeNotes}
                onChange={(v) => setFormData((prev) => ({ ...prev, dreamHomeNotes: v }))}
                placeholder="Share your vision..."
              />

              <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-6 mt-6">
                <div className="flex items-center gap-3 mb-4">
                  <Check className="h-8 w-8 text-green-500" />
                  <h4 className="text-lg font-semibold text-green-400">You're All Set!</h4>
                </div>
                <p className="text-sm text-gray-300 mb-4">
                  Thank you for sharing your vision with such detail. Our team will analyze your preferences 
                  and curate a personalized selection of properties that match your goals, lifestyle, and budget.
                </p>
                <p className="text-sm text-gray-400">
                  Expect to hear from us within 24-48 hours with your tailored recommendations.
                </p>
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="p-6 border-t border-gray-700 flex justify-between">
          <div>
            {step > 1 && (
              <Button variant="outline" onClick={handleBack}>
                <ChevronLeft className="h-4 w-4 mr-1" />
                Back
              </Button>
            )}
          </div>
          <div className="flex gap-2">
            <Button variant="secondary" onClick={onCancel}>
              Cancel
            </Button>
            {step < STEPS.length ? (
              <Button onClick={handleNext}>
                Next
                <ChevronRight className="h-4 w-4 ml-1" />
              </Button>
            ) : (
              <Button onClick={handleSubmit} disabled={loading} className="bg-green-600 hover:bg-green-700">
                {loading ? "Submitting..." : "Submit"}
              </Button>
            )}
          </div>
        </div>
      </div>
    );
  }

  // Modal mode
  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-3xl max-h-[90vh] flex flex-col">
        {renderFormContent()}
      </div>
    </div>
  );
}
